# One-Shot Playbook — Idea to Shipped

Complete end-to-end guide for turning an idea into a deployed product using the planning machine + Naomi execution engine.

## Prerequisites

- `TAVILY_API_KEY` or `BRAVE_SEARCH_API_KEY` set in `.dev.vars`
- `ANTHROPIC_API_KEY` set in `.dev.vars`
- `FOUNDATION_API_KEY` set (for API calls to planning machine)
- `wrangler` authenticated (`npx wrangler login`)
- pnpm installed (`npm i -g pnpm`)

## Step 1: Start the Planning Machine

```bash
cd cloudflare-foundation-dev
pnpm install
npx wrangler dev services/planning-machine/src/index.ts --port 8788
```

## Step 2: Run the Planning Phase

Open Claude Code and run:

```
/plan "Your product idea in 1-2 sentences"
```

This runs:
1. **Phase 0 (Intake)** — captures tech stack, team size, budget, constraints
2. **Phases 1–4 (Discovery)** — market research with live web search citations
3. **Phase 5 (Kill Test)** — GO / KILL / PIVOT decision
4. **Phases 6–15 (Strategy → Synthesis)** — full strategic analysis
5. **Phase 16 (Reconciliation)** — generates TASKS.json

If Phase 5 returns KILL, the run stops. If PIVOT, you'll be prompted for adjustments.

**Duration:** 15–45 minutes depending on depth

## Step 3: Review TASKS.json

```bash
cat planning-machine/output/<RUN_ID>/TASKS.json | jq '.summary'
```

Check:
- Total tasks reasonable (expect 40–80 for an MVP)
- No circular dependencies: `grep -c "blockedBy" TASKS.json`
- Build phases all populated: `jq '.buildPhases[].taskIds | length' TASKS.json`
- Critical path identified: `jq '.summary.criticalPath' TASKS.json`

Review `EXECUTION_RULES.md` — these are the product-specific rules Naomi will follow.

## Step 4: Generate Scaffold Files

If not already generated by `/plan`:

```bash
npx tsx planning-machine/scripts/generate-scaffold.ts <RUN_ID>
```

This populates:
- `planning-machine/output/<RUN_ID>/BOOTSTRAP.md` — wrangler bindings, deploy order
- `planning-machine/output/<RUN_ID>/DATA_MODEL.md` — entity-storage map
- `planning-machine/output/<RUN_ID>/EXECUTION_RULES.md` — Claude Code rules

## Step 5: Provision Infrastructure

Follow `BOOTSTRAP.md`:

```bash
pnpm install
bash scripts/setup-all.sh  # Creates D1, KV, R2, Queue resources
wrangler d1 execute <DB_NAME> --remote --file migrations/0000_init.sql
wrangler secret put JWT_SECRET
wrangler secret put CONTEXT_SIGNING_KEY
```

## Step 6: Send TASKS.json to Naomi

```bash
curl -X POST https://your-gateway.workers.dev/api/naomi/tasks/bulk-create \
  -H "Authorization: Bearer $FOUNDATION_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "projectId": "<RUN_ID>",
    "repoUrl": "https://github.com/your-org/your-repo",
    "tasks": [...],
    "marketingTasks": [...]
  }'
```

Or use the scaffold script:

```bash
npx tsx planning-machine/scripts/send-to-naomi.ts <RUN_ID>
```

Tasks appear in the Naomi Kanban at `/ai-labs/production` ordered by buildPhase.

## Step 7: Monitor Execution

Tasks execute in build phase order. Naomi:
1. Claims a pending task
2. Executes it using the task's `naomiPrompt`
3. Reports verification results to `POST /api/naomi/tasks/:id/verification`
4. On pass → marks task `completed`
5. On fail → re-queues with failure context (max 3 attempts)

Monitor progress:

```bash
# List tasks by status
curl "$GATEWAY_URL/api/naomi/tasks?status=running" -H "Authorization: Bearer $KEY"

# Get task details with logs
curl "$GATEWAY_URL/api/naomi/tasks/<TASK_ID>" -H "Authorization: Bearer $KEY"
```

## Step 8: Handle Human Review Tasks

Tasks with `mergeStrategy: "human-review-required"` will create PRs that need review:
- Security tasks touching auth/payment
- Tasks modifying `services/gateway/src/index.ts` (high conflict risk)
- All marketing tasks (`humanReviewRequired: true`)

Review and merge these PRs. Downstream tasks are unblocked automatically once merged.

## Step 9: Capture Lessons

After the build completes, capture what you learned:

```bash
npx tsx planning-machine/scripts/capture-lessons.ts add \
  --product-type crud-saas \
  --category task-sizing \
  --lesson "Database migration task must be separate from schema definition task" \
  --applies-to "database,devops"
```

Lessons are injected into Phase 16 for all future builds.

## Failure Recovery

### Task stuck in "running" for >2 hours

```bash
curl -X POST "$GATEWAY_URL/api/naomi/tasks/<ID>/progress" \
  -H "Authorization: Bearer $KEY" \
  -d '{"status": "pending", "error": null}'
```

### Verification loop stuck (>3 failures)

Tasks escalated to human review appear with `status: "failed"`. Fix manually, then:

```bash
# Reset to pending with manual fix notes
curl -X POST "$GATEWAY_URL/api/naomi/tasks/<ID>/progress" \
  -H "Authorization: Bearer $KEY" \
  -d '{"status": "pending"}'
```

### Re-run Phase 16 with updated constraints

Edit `planning-machine/memory/pipeline-memory.json` to add blocking lessons, then:

```bash
/plan:tasks <RUN_ID>
```

This re-runs reconciliation and updates TASKS.json without re-running the full research pipeline.
