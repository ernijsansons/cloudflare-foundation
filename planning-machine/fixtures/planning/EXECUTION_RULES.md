# Execution Rules — {{PROJECT_NAME}}

> Generated by `planning-machine/scripts/generate-scaffold.ts` after a planning run.
> These rules are product-specific and override any generic Claude Code defaults.
> The {{PLACEHOLDERS}} are replaced with real values from your planning run.

## Stack Constraints

- **Platform:** Cloudflare-native (Workers, D1, KV, R2, Queues, Durable Objects)
- **Frontend:** SvelteKit with Cloudflare adapter
- **Backend:** Hono API Gateway on Cloudflare Workers
- **Database:** D1 (SQLite) via Drizzle ORM
- **Budget stage:** {{BUDGET_RANGE}}
- **Team:** {{TEAM_SIZE}}

## Naming Conventions (MANDATORY)

- Files: `kebab-case.ts` (e.g., `auth-service.ts`)
- TypeScript functions and variables: `camelCase`
- TypeScript types and classes: `PascalCase`
- Database columns: `snake_case`
- Cloudflare bindings: `UPPER_SNAKE_CASE`
- Route handlers: `app.METHOD("/api/path", middleware(), handler)`

## Architecture Patterns (DO NOT DEVIATE)

1. All HTTP routes are in `services/gateway/src/index.ts` via Hono
2. Auth is `authMiddleware()` — apply to all `/api/*` routes
3. Tenant isolation is `tenantMiddleware()` — all DB queries bind `tenant_id`
4. File uploads go to R2 via `services/gateway/src/index.ts` POST `/api/files/upload`
5. Analytics events go to Analytics Engine via POST `/api/analytics/event`
6. Audit events go to D1 `audit_chain` table via `appendAuditEvent()`
7. Background jobs use Cloudflare Queues — never direct API calls
8. Durable Objects are in `services/agents/` — register in `wrangler.jsonc`

## Product-Specific Decisions

{{TECHNICAL_DECISIONS}}

## What NOT To Do

- DO NOT cross-import between services (e.g., `import` from gateway in cron)
- DO NOT use hardcoded IDs in wrangler config
- DO NOT skip `tenant_id` on any D1 query
- DO NOT expose raw error messages to the client
- DO NOT use any technology in the MUST AVOID list: {{MUST_AVOID}}
- DO NOT add paid external APIs without justification for {{BUDGET_RANGE}} stage

## Environment Variables Required

{{ENVIRONMENT_VARIABLES}}

## Test Requirements

- Unit tests: `vitest` in `__tests__/` adjacent to source
- Integration tests: test the full request → response → DB round trip
- E2E tests: test at least one complete user journey per feature
- All tests must pass before a task is considered complete

## Security Checklist (run for every task touching user data)

- [ ] All inputs validated and sanitized
- [ ] SQL injection prevented (parameterized queries only)
- [ ] IDOR prevented (tenant_id checked on every query)
- [ ] Auth checked before any data access
- [ ] File uploads validate type and size
- [ ] No secrets in logs or error messages
