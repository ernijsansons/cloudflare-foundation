# Wrangler Configuration - Staging Environment
# Planning Machine Service - Staging Deployment

name = "foundation-planning-machine-staging"
main = "src/index.ts"
compatibility_date = "2024-01-01"
node_compat = true

# Account Configuration (replace with your Cloudflare account ID)
account_id = "" # Set via environment variable: CLOUDFLARE_ACCOUNT_ID

# Workers Configuration
workers_dev = false
route = { pattern = "planning-staging.foundation.dev/*", zone_name = "foundation.dev" }

# Observability
observability = { enabled = true }
logpush = true

# ============================================================================
# BINDINGS
# ============================================================================

# D1 Database (Staging)
[[d1_databases]]
binding = "DB"
database_name = "foundation-db-staging"
database_id = "" # Set via: wrangler d1 create foundation-db-staging

# Vectorize Index (Staging)
[[vectorize]]
binding = "VECTORIZE"
index_name = "foundation-vectors-staging"

# R2 Storage (Staging)
[[r2_buckets]]
binding = "ARTIFACTS_BUCKET"
bucket_name = "foundation-artifacts-staging"

# KV Namespaces (Staging)
[[kv_namespaces]]
binding = "CACHE"
id = "" # Created with: wrangler kv:namespace create "CACHE" --preview false

[[kv_namespaces]]
binding = "SESSIONS"
id = "" # Created with: wrangler kv:namespace create "SESSIONS" --preview false

# Workers AI
[ai]
binding = "AI"

# Queue for background processing
[[queues.producers]]
binding = "TASK_QUEUE"
queue = "foundation-tasks-staging"

[[queues.consumers]]
queue = "foundation-tasks-staging"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "foundation-tasks-staging-dlq"

# Durable Objects (if needed for real-time features)
[[durable_objects.bindings]]
name = "CONSENSUS_COORDINATOR"
class_name = "ConsensusCoordinator"
script_name = "foundation-planning-machine-staging"

# ============================================================================
# ENVIRONMENT VARIABLES
# ============================================================================

[vars]
ENVIRONMENT = "staging"
LOG_LEVEL = "debug"
API_VERSION = "v1"
MAX_CONSENSUS_MODELS = "5"
CONSENSUS_TIMEOUT_MS = "30000"
QUALITY_THRESHOLD = "85"
ENABLE_DEBUG_LOGGING = "true"
ENABLE_PERFORMANCE_TRACKING = "true"

# Feature Flags
ENABLE_ML_PREDICTIONS = "true"
ENABLE_VECTOR_SEARCH = "true"
ENABLE_EXTERNAL_INTEGRATIONS = "true"
ENABLE_AUDIT_LOGGING = "true"

# Rate Limiting (more permissive in staging)
RATE_LIMIT_REQUESTS_PER_MINUTE = "120"
RATE_LIMIT_BURST = "20"

# ============================================================================
# SECRETS (Set via: wrangler secret put <NAME> --env staging)
# ============================================================================

# DATABASE_ENCRYPTION_KEY - For encrypting sensitive data
# JWT_SECRET - For authentication tokens
# WEBHOOK_SIGNING_SECRET - For webhook signature verification
# OPENAI_API_KEY - If using OpenAI models
# ANTHROPIC_API_KEY - If using Anthropic models
# SLACK_WEBHOOK_URL - For notifications
# SENTRY_DSN - For error tracking

# ============================================================================
# RESOURCE LIMITS
# ============================================================================

[limits]
cpu_ms = 30000 # 30 seconds CPU time per request (Workers Paid)

# ============================================================================
# BUILD CONFIGURATION
# ============================================================================

[build]
command = "npm run build"

[build.upload]
format = "modules"
main = "./dist/index.js"

# ============================================================================
# COMPATIBILITY FLAGS
# ============================================================================

[compatibility_flags]
nodejs_compat = true
